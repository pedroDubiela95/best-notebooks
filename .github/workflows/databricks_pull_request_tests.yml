name: Run pre-merge Databricks tests

on:
  pull_request:

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  unit-test-notebook:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      # Instala o Databricks CLI oficial
      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      # Roda notebook via Jobs API usando Serverless
      - name: Run test notebook (Serverless via Jobs API)
        run: |
          databricks jobs run-now \
            --json '{
              "run_name": "eda-transforms-unit-tests",
              "tasks": [
                {
                  "task_key": "unit_tests",
                  "notebook_task": {
                    "notebook_path": "/Repos/SEU_ORG/SEU_REPO/notebooks/run_unit_tests"
                  },
                  "compute": {
                    "compute_type": "SERVERLESS"
                  }
                }
              ]
            }'
